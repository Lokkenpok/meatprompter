<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meat Smoothie - Song Extractor</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1a1a1a;
        color: #ffffff;
        margin: 0;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
      }
      h1 {
        color: #ff6b6b;
        margin-bottom: 10px;
        text-align: center;
      }
      h2 {
        color: #ddd;
        font-size: 16px;
        font-weight: normal;
        text-align: center;
        margin-bottom: 20px;
      }
      .status {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .buttons {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
      button {
        padding: 10px 15px;
        background-color: #ff6b6b;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
      }
      button:hover {
        background-color: #fa5252;
      }
      button:disabled {
        background-color: #666;
        cursor: not-allowed;
      }
      .song-info {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .song-info div {
        margin-bottom: 10px;
      }
      .label {
        font-weight: bold;
        color: #aaa;
        margin-right: 5px;
      }
      .value {
        color: #fff;
      }
      .error {
        color: #ff6b6b;
        font-weight: bold;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      .footer {
        text-align: center;
        margin-top: 20px;
        font-size: 12px;
        color: #888;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Meat Smoothie</h1>
      <h2>Song Extractor</h2>

      <div class="status" id="status">
        Connecting to Ultimate Guitar page...
      </div>

      <div class="song-info" id="song-info" style="display: none">
        <div>
          <span class="label">Song:</span>
          <span class="value" id="song-title">-</span>
        </div>
        <div>
          <span class="label">Artist:</span>
          <span class="value" id="song-artist">-</span>
        </div>
        <div>
          <span class="label">Content:</span>
          <span class="value" id="content-status">-</span>
        </div>
      </div>

      <div class="buttons">
        <button id="extract-button" disabled>
          Extract & Open in Teleprompter
        </button>
      </div>

      <div class="footer">Meat Smoothie Band Teleprompter</div>
    </div>

    <script>
      // Get the URL of the Ultimate Guitar page
      const params = new URLSearchParams(window.location.search);
      const targetUrl = params.get("url");
      const statusElement = document.getElementById("status");
      const songInfoElement = document.getElementById("song-info");
      const extractButton = document.getElementById("extract-button");
      const titleElement = document.getElementById("song-title");
      const artistElement = document.getElementById("song-artist");
      const contentStatusElement = document.getElementById("content-status");

      // Store the extracted data
      let extractedData = null;

      // Main function to extract song data
      function extractSong() {
        // Make sure we have a valid Ultimate Guitar URL
        if (!targetUrl || !targetUrl.includes("ultimate-guitar.com")) {
          showError("Invalid URL. This only works with Ultimate Guitar pages.");
          return;
        }

        statusElement.textContent = "Connecting to Ultimate Guitar...";

        // Set up a message listener to receive data from the UG page
        window.addEventListener("message", function (event) {
          try {
            const data = JSON.parse(event.data);

            if (data.title) {
              // Successfully received song data
              extractedData = data;
              titleElement.textContent = data.title;
              artistElement.textContent = data.artist;
              contentStatusElement.textContent = data.content
                ? `${data.content.length} characters extracted`
                : "No content found";

              songInfoElement.style.display = "block";
              statusElement.innerHTML =
                '<span class="success">Song data successfully extracted!</span>';
              extractButton.disabled = false;
            } else if (data.error) {
              // Received an error message
              showError(data.error);
            }
          } catch (e) {
            console.log("Received invalid message:", event.data);
          }
        });

        // Try to connect to the Ultimate Guitar page via iframe for extraction
        const invisibleFrame = document.createElement("iframe");
        invisibleFrame.style.display = "none";
        invisibleFrame.src = targetUrl;
        document.body.appendChild(invisibleFrame);

        // If we don't get a response in 5 seconds, show instructions for manual extraction
        setTimeout(function () {
          if (!extractedData) {
            showManualInstructions();
          }
        }, 5000);
      }

      // Show instructions for manual copy-paste
      function showManualInstructions() {
        statusElement.innerHTML = `
          <p class="error">Automatic extraction failed. Please follow these steps:</p>
          <ol>
            <li>Go back to the Ultimate Guitar tab in your browser</li>
            <li>Press F12 to open developer tools</li>
            <li>Click on the "Console" tab</li>
            <li>Copy and paste this code into the console:</li>
          </ol>
          <pre style="background:#222;padding:10px;overflow:auto;font-size:12px">
var title = document.querySelector('h1')?.innerText || 'Unknown Song';
var artist = document.querySelector('[class*="artist"]')?.innerText || 'Unknown Artist';
var content = '';

// Try to get content from multiple sources
if (window.UGAPP?.store?.page?.data?.tab_view?.wiki_tab?.content) {
  content = window.UGAPP.store.page.data.tab_view.wiki_tab.content;
} else {
  var tabElement = document.querySelector('.js-tab-content, pre.tab-content');
  if (tabElement) content = tabElement.innerText;
}

// Create data object
var data = {title: title, artist: artist, content: content};

// Copy to clipboard
copy(JSON.stringify(data));
console.log('âœ… Song data copied! Paste it in the extractor window.');
          </pre>
          <p>After running the code, click the button below and paste the copied data:</p>
        `;

        // Change button to "paste data" mode
        extractButton.textContent = "Paste Song Data";
        extractButton.disabled = false;
        extractButton.onclick = function () {
          const songData = prompt("Paste the copied song data here:");
          if (songData) {
            try {
              const parsedData = JSON.parse(songData);
              if (parsedData.title && parsedData.content) {
                extractedData = parsedData;
                titleElement.textContent = parsedData.title;
                artistElement.textContent =
                  parsedData.artist || "Unknown Artist";
                contentStatusElement.textContent = `${parsedData.content.length} characters extracted`;
                songInfoElement.style.display = "block";
                statusElement.innerHTML =
                  '<span class="success">Song data successfully extracted!</span>';

                // Change button back to open teleprompter
                extractButton.textContent = "Open in Teleprompter";
                extractButton.onclick = openInTeleprompter;
              } else {
                showError("Invalid song data format. Please try again.");
              }
            } catch (e) {
              showError("Could not parse the pasted data. Please try again.");
            }
          }
        };
      }

      // Show error message
      function showError(message) {
        statusElement.innerHTML = `<span class="error">${message}</span>`;
        extractButton.disabled = true;
      }

      // Open the song in the teleprompter
      function openInTeleprompter() {
        if (!extractedData) {
          showError("No song data to send to teleprompter.");
          return;
        }

        try {
          // Get the current location to build the correct teleprompter path
          const currentPath = window.location.pathname;
          // Remove "extractor.html" from the path to get the base directory
          const basePath = currentPath.substring(
            0,
            currentPath.lastIndexOf("/") + 1
          );
          // Construct the teleprompter URL
          const teleprompterUrl =
            window.location.origin + basePath + "index.html";

          // Encode data for URL
          const encodedData = encodeURIComponent(JSON.stringify(extractedData));

          // Show success message
          statusElement.innerHTML =
            '<span class="success">Opening teleprompter...</span>';

          // Open the teleprompter in a new window
          const teleprompterWindow = window.open(
            `${teleprompterUrl}?songData=${encodedData}`,
            "_blank"
          );

          // Check if the window was successfully opened
          if (teleprompterWindow) {
            // Close this window after a short delay
            setTimeout(function () {
              window.close();
            }, 1000);
          } else {
            // If window.open was blocked by a popup blocker
            statusElement.innerHTML = `
              <span class="error">Popup blocked. Please click the link below:</span>
              <p><a href="${teleprompterUrl}?songData=${encodedData}" target="_blank" 
                 style="color:#ff6b6b;display:block;margin-top:10px;text-align:center;">
                 Open in Teleprompter
              </a></p>
            `;
          }
        } catch (err) {
          showError("Error opening teleprompter: " + err.message);
          console.error(err);
        }
      }

      // Set up button handler
      extractButton.onclick = openInTeleprompter;

      // Start extraction process when page loads
      window.onload = extractSong;
    </script>
  </body>
</html>
